<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ultimate Form Tracking (Config Mode)</title>
    
    <script>
        // Domain Key b·∫Øt bu·ªôc
        window.__RECSYS_DOMAIN_KEY__ = '079251187f351b700844164bf0ac5fddebaa305af8732fe06ae631b921eaf9e7';

        // C·∫•u h√¨nh SDK gi·∫£ l·∫≠p (Thay v√¨ g·ªçi API l·∫•y config, ta khai b√°o lu√¥n ·ªü ƒë√¢y)
        window.RecSysTrackerConfig = {
            trackEndpoint: 'http://localhost:3000/track', // Endpoint g·ª≠i log (dummy)
            trackingRules: [
                // --- CASE 1: Internal Form (Hidden Input) ---
                // Target: Form c√≥ ID l√† "form-internal"
                {
                    id: 'RULE-INTERNAL', 
                    name: 'Test Internal Form (Hidden Input)', 
                    triggerEventId: 2, // 2 = FORM_SUBMIT
                    targetElement: { 
                        targetElementValue: '#form-internal', 
                        targetEventPatternId: 1, // 1 = CSS SELECTOR
                        targetOperatorId: 5      // 5 = EQUALS
                    },
                    payload: []
                },
                // --- CASE 2: Context Form (Radar Scan) ---
                // Target: Form c√≥ ID l√† "form-context"
                {
                    id: 'RULE-CONTEXT', 
                    name: 'Test Context Form (Radar Scan)', 
                    triggerEventId: 2,
                    targetElement: { 
                        targetElementValue: '#form-context', 
                        targetEventPatternId: 1, 
                        targetOperatorId: 5 
                    },
                    payload: []
                },
                // --- CASE 3: URL Fallback ---
                // Target: Form c√≥ ID l√† "form-url"
                {
                    id: 'RULE-URL', 
                    name: 'Test URL Fallback', 
                    triggerEventId: 2,
                    targetElement: { 
                        targetElementValue: '#form-url', 
                        targetEventPatternId: 1, 
                        targetOperatorId: 5 
                    },
                    payload: []
                },
                // --- CASE 4: Attribute Match (Complex Rule) ---
                // Target: Form c√≥ data-form-name="special-form"
                // Pattern 4 = DATA_ATTRIBUTE (Check code checkTargetMatch trong plugin)
                {
                    id: 'RULE-ATTR', 
                    name: 'Test Attribute Match', 
                    triggerEventId: 2,
                    targetElement: { 
                        targetElementValue: 'special-form', 
                        targetEventPatternId: 4, // 4 = DATA_ATTRIBUTE
                        targetOperatorId: 5      // 5 = EQUALS
                    },
                    payload: []
                }
            ]
        };
    </script>
    
    <script src="http://localhost:3000/dist/loader.js"></script>
    
    <style>
        body { font-family: 'Segoe UI', sans-serif; background: #f4f6f8; padding: 20px; max-width: 1100px; margin: 0 auto; color: #333; }
        h1, h2 { margin-top: 0; }
        .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-top: 20px; }
        .card { background: white; padding: 20px; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); border-left: 5px solid #ddd; position: relative; }
        
        /* M√†u s·∫Øc cho t·ª´ng m·ª©c ƒë·ªô ∆∞u ti√™n */
        .p1 { border-left-color: #28a745; } /* Xanh l√° */
        .p2 { border-left-color: #17a2b8; } /* Xanh d∆∞∆°ng */
        .p3 { border-left-color: #ffc107; } /* V√†ng */
        .p4 { border-left-color: #dc3545; } /* ƒê·ªè */
        
        .badge { position: absolute; top: 15px; right: 15px; background: #333; color: white; padding: 4px 8px; border-radius: 4px; font-size: 11px; font-weight: bold; }
        
        form { margin-top: 15px; display: grid; gap: 10px; }
        input, select, textarea { width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 4px; box-sizing: border-box; }
        button { padding: 10px; border: none; border-radius: 4px; cursor: pointer; font-weight: bold; color: white; transition: 0.2s; }
        button:hover { opacity: 0.9; }
        
        .btn-submit { background: #2c3e50; }
        .btn-action { background: #6c757d; font-size: 12px; padding: 5px 10px; }

        /* Console Log Box */
        #console-box { background: #1e1e1e; color: #cfcfcf; padding: 15px; border-radius: 8px; height: 350px; overflow-y: auto; font-family: 'Consolas', monospace; font-size: 13px; margin-top: 30px; border: 1px solid #333; }
        .log-item { border-bottom: 1px solid #333; padding: 5px 0; }
        .log-success { color: #4ec9b0; } 
        .log-info { color: #569cd6; }
        .log-warn { color: #ce9178; }
    </style>
</head>
<body>

    <div style="text-align: center;">
        <h1>Form Tracking: Config Mode</h1>
        <p>Test logic "Tam Tr·ª•" (Hidden Input > Radar > URL) m√† kh√¥ng c·∫ßn Server.</p>
    </div>

    <div class="grid">
        <div class="card p4">
            <h2>üë§ User Identity</h2>
            <div id="login-form">
                <input type="text" id="uid" value="USER-VIP-888" placeholder="User ID...">
                <button onclick="login()" style="background:#6610f2; margin-top:5px; width:100%">Simulate Login</button>
            </div>
            <div id="logged-form" style="display:none">
                <p>Logged in as: <strong id="show-uid" style="color:#6610f2"></strong></p>
                <button onclick="logout()" style="background:#dc3545; width:100%">Logout</button>
            </div>
        </div>
        
        <div class="card p3">
            <h2>üîó URL Params</h2>
            <p>Tr·∫°ng th√°i: <strong id="url-stt">...</strong></p>
            <button class="btn-action" onclick="setUrlParam()">Th√™m ?id=URL-ITEM-999</button>
            <button class="btn-action" onclick="resetUrl()">X√≥a Param</button>
        </div>
    </div>

    <div class="grid">
        
        <div class="card p1">
            <span class="badge" style="background:#28a745">PRIORITY 1</span>
            <h2>1. Hidden Input</h2>
            <p style="font-size:0.9em; color:#666">Form ch·ª©a input ·∫©n <code>productId</code>. Plugin s·∫Ω l·∫•y ID n√†y b·∫•t ch·∫•p m·ªçi th·ª©.</p>
            
            <form id="form-internal" onsubmit="handleSubmit(event)">
                <input type="hidden" name="productId" value="ITEM-INTERNAL-123">
                <input type="hidden" name="productName" value="Hidden Gem Product">
                
                <label>Rating:</label>
                <select name="rate"><option value="5">5 Stars</option></select>
                <label>Review:</label>
                <textarea name="review">S·∫£n ph·∫©m n√†y c√≥ ID ·∫©n!</textarea>
                <button type="submit" class="btn-submit">G·ª≠i (Internal)</button>
            </form>
        </div>

        <div class="card p2" 
             data-item-id="ITEM-CONTEXT-456" 
             data-item-name="Context Wrapper Item"
             data-item-type="product">
             
            <span class="badge" style="background:#17a2b8">PRIORITY 2</span>
            <h2>2. Context Radar</h2>
            <p style="font-size:0.9em; color:#666">Form kh√¥ng c√≥ ID, nh∆∞ng th·∫ª cha ch·ª©a <code>data-item-id</code>. Plugin s·∫Ω qu√©t th·∫•y.</p>
            
            <form id="form-context" onsubmit="handleSubmit(event)">
                <label>Rating:</label>
                <select name="rating"><option value="4">4 Stars</option></select>
                <label>Comment:</label>
                <textarea name="content">Form n√†y ƒÉn theo ID c·ªßa th·∫ª cha.</textarea>
                <button type="submit" class="btn-submit">G·ª≠i (Context)</button>
            </form>
        </div>

        <div class="card p3">
            <span class="badge" style="background:#ffc107; color:black">PRIORITY 3</span>
            <h2>3. URL Fallback</h2>
            <p style="font-size:0.9em; color:#666">Form tr∆° tr·ªçi. Plugin s·∫Ω t√¨m ID tr√™n URL (Nh·ªõ b·∫•m n√∫t th√™m URL Param ·ªü tr√™n).</p>
            
            <form id="form-url" onsubmit="handleSubmit(event)">
                <label>Score:</label>
                <select name="score"><option value="3">3 Stars</option></select>
                <label>Feedback:</label>
                <textarea name="body">L·∫•y ID t·ª´ thanh ƒë·ªãa ch·ªâ nh√©.</textarea>
                <button type="submit" class="btn-submit">G·ª≠i (URL)</button>
            </form>
        </div>

        <div class="card p4">
            <span class="badge" style="background:#dc3545">COMPLEX</span>
            <h2>4. Attribute Match</h2>
            <p style="font-size:0.9em; color:#666">Rule match b·∫±ng <code>data-form-name</code> thay v√¨ ID.</p>
            
            <form data-form-name="special-form" onsubmit="handleSubmit(event)">
                <input type="hidden" name="itemId" value="ITEM-SPECIAL-789">
                <label>Rating:</label>
                <input type="number" name="star" value="5">
                <button type="submit" class="btn-submit">G·ª≠i (Special)</button>
            </form>
        </div>
    </div>

    <div id="console-box">
        <div class="log-item">Waiting for interactions...</div>
    </div>

    <script>
        // --- LOGIC GIAO DI·ªÜN & HELPER ---

        // 1. User Identity Logic
        function checkUser() {
            const u = localStorage.getItem('user_id');
            if(u) {
                document.getElementById('login-form').style.display='none';
                document.getElementById('logged-form').style.display='block';
                document.getElementById('show-uid').innerText = u;
                log(`üë§ Current User: ${u}`, 'log-info');
            }
        }
        function login() {
            localStorage.setItem('user_id', document.getElementById('uid').value);
            location.reload();
        }
        function logout() {
            localStorage.removeItem('user_id');
            location.reload();
        }

        // 2. URL Logic
        const params = new URLSearchParams(location.search);
        const urlId = params.get('id');
        document.getElementById('url-stt').innerText = urlId ? `‚úÖ ID=${urlId}` : '‚ùå Kh√¥ng c√≥';
        document.getElementById('url-stt').style.color = urlId ? '#28a745' : '#dc3545';

        function setUrlParam() {
            const url = new URL(window.location);
            url.searchParams.set('id', 'URL-ITEM-999');
            window.history.pushState({}, '', url);
            location.reload();
        }
        function resetUrl() {
            const url = new URL(window.location);
            url.searchParams.delete('id');
            window.history.pushState({}, '', url);
            location.reload();
        }

        // 3. Logger Logic
        function log(msg, cls='') {
            const box = document.getElementById('console-box');
            const div = document.createElement('div');
            div.className = 'log-item ' + cls;
            div.innerHTML = `<span style="opacity:0.6">[${new Date().toLocaleTimeString()}]</span> ${msg}`;
            box.prepend(div);
        }

        function handleSubmit(e) {
            e.preventDefault(); // Ch·∫∑n reload ƒë·ªÉ xem log
            log(`üìù Submitting form... Check SDK logs!`, 'log-warn');
        }

        // Override console.log ƒë·ªÉ soi SDK
        const _log = console.log;
        console.log = function(...args) {
            _log.apply(console, args);
            const txt = args.map(a => typeof a==='object'?JSON.stringify(a):a).join(' ');
            
            // L·ªçc log t·ª´ SDK FormPlugin
            if(txt.includes('[FormPlugin]') || txt.includes('payload') || txt.includes('Enqueue')) {
                if(txt.includes('Enqueue')) log("üöÄ PAYLOAD SENT: " + txt, 'log-success');
                else if(txt.includes('Hidden Input')) log("üí° DETECTED: " + txt, 'log-info');
                else if(txt.includes('Found Context')) log("üì° RADAR: " + txt, 'log-info');
                else log(txt);
            }
        }

        // Init
        checkUser();
    </script>
</body>
</html>