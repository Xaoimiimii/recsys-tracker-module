<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Event Posting to Server</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1200px;
            margin: 20px auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        h1, h2 {
            color: #333;
        }
        .form-group {
            margin-bottom: 15px;
        }
        label {
            display: block;
            font-weight: bold;
            margin-bottom: 5px;
            color: #555;
        }
        input, select, textarea {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            box-sizing: border-box;
        }
        button {
            background-color: #007bff;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
            margin-right: 10px;
        }
        button:hover {
            background-color: #0056b3;
        }
        .btn-success {
            background-color: #28a745;
        }
        .btn-success:hover {
            background-color: #218838;
        }
        .btn-danger {
            background-color: #dc3545;
        }
        .btn-danger:hover {
            background-color: #c82333;
        }
        .btn-warning {
            background-color: #ffc107;
            color: #212529;
        }
        .btn-warning:hover {
            background-color: #e0a800;
        }
        .log-container {
            background: #1e1e1e;
            color: #d4d4d4;
            padding: 15px;
            border-radius: 4px;
            max-height: 400px;
            overflow-y: auto;
            font-family: 'Courier New', monospace;
            font-size: 14px;
        }
        .log-entry {
            margin-bottom: 5px;
            padding: 5px;
            border-left: 3px solid #007bff;
            padding-left: 10px;
        }
        .log-success {
            border-left-color: #28a745;
            color: #90ee90;
        }
        .log-error {
            border-left-color: #dc3545;
            color: #ff6b6b;
        }
        .log-warning {
            border-left-color: #ffc107;
            color: #ffd54f;
        }
        .stats {
            display: flex;
            justify-content: space-around;
            margin-top: 10px;
        }
        .stat-item {
            text-align: center;
            padding: 10px;
            background: #f8f9fa;
            border-radius: 4px;
            flex: 1;
            margin: 0 5px;
        }
        .stat-label {
            font-size: 12px;
            color: #666;
        }
        .stat-value {
            font-size: 24px;
            font-weight: bold;
            color: #007bff;
        }
        .grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }
        @media (max-width: 768px) {
            .grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
    <script>
        // Mock configuration cho SDK
        window.RecSysConfig = {
            domainKey: 'test-domain',
            apiUrl: 'http://localhost:3000',
            trackEndpoint: 'http://localhost:3000/api/events',
            returnMethods: []
        };
    </script>
</head>
<body>
    <h1>üß™ Test Event Posting to Server</h1>
    
    <div class="grid">
        <!-- Form g·ª≠i event ƒë∆°n l·∫ª -->
        <div class="container">
            <h2>üì§ G·ª≠i Event ƒê∆°n L·∫ª</h2>
            <form id="single-event-form">
                <div class="form-group">
                    <label>Event Type ID:</label>
                    <select name="eventTypeId" required>
                        <option value="1">1 - Click</option>
                        <option value="2">2 - View</option>
                        <option value="3" selected>3 - Rating</option>
                        <option value="4">4 - Review</option>
                        <option value="5">5 - Purchase</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label>Tracking Rule ID:</label>
                    <input type="number" name="trackingRuleId" value="1" required />
                </div>
                
                <div class="form-group">
                    <label>Domain Key:</label>
                    <input type="text" name="domainKey" value="test-domain" required />
                </div>
                
                <div class="form-group">
                    <label>User Field:</label>
                    <input type="text" name="userField" value="userId" required />
                </div>
                
                <div class="form-group">
                    <label>User Value:</label>
                    <input type="text" name="userValue" value="user123" required />
                </div>
                
                <div class="form-group">
                    <label>Item Field:</label>
                    <input type="text" name="itemField" value="itemId" required />
                </div>
                
                <div class="form-group">
                    <label>Item Value:</label>
                    <input type="text" name="itemValue" value="item456" required />
                </div>
                
                <div class="form-group">
                    <label>Rating Value (optional):</label>
                    <input type="number" name="ratingValue" min="1" max="5" step="0.1" />
                </div>
                
                <div class="form-group">
                    <label>Review Value (optional):</label>
                    <textarea name="reviewValue" rows="3"></textarea>
                </div>
                
                <button type="submit">G·ª≠i Event</button>
                <button type="button" onclick="fillSampleData()">ƒêi·ªÅn d·ªØ li·ªáu m·∫´u</button>
            </form>
        </div>

        <!-- Form g·ª≠i batch events -->
        <div class="container">
            <h2>üì¶ G·ª≠i Batch Events</h2>
            <div class="form-group">
                <label>S·ªë l∆∞·ª£ng events:</label>
                <input type="number" id="batch-count" value="5" min="1" max="100" />
            </div>
            
            <div class="form-group">
                <label>Event Type:</label>
                <select id="batch-event-type">
                    <option value="1">Click</option>
                    <option value="2">View</option>
                    <option value="3">Rating</option>
                    <option value="4">Review</option>
                    <option value="5">Purchase</option>
                </select>
            </div>
            
            <button onclick="sendBatchEvents()">G·ª≠i Batch</button>
            <button onclick="sendRandomEvents()" class="btn-warning">G·ª≠i Random Events</button>
            
            <div style="margin-top: 20px;">
                <h3>Actions:</h3>
                <button onclick="testOfflineMode()" class="btn-success">Test Offline Mode</button>
                <button onclick="testRetryLogic()" class="btn-warning">Test Retry Logic</button>
                <button onclick="clearBuffer()" class="btn-danger">Clear Buffer</button>
            </div>
        </div>
    </div>

    <!-- Statistics -->
    <div class="container">
        <h2>üìä Statistics</h2>
        <div class="stats">
            <div class="stat-item">
                <div class="stat-label">Events Sent</div>
                <div class="stat-value" id="stat-sent">0</div>
            </div>
            <div class="stat-item">
                <div class="stat-label">Success</div>
                <div class="stat-value" id="stat-success" style="color: #28a745;">0</div>
            </div>
            <div class="stat-item">
                <div class="stat-label">Failed</div>
                <div class="stat-value" id="stat-failed" style="color: #dc3545;">0</div>
            </div>
            <div class="stat-item">
                <div class="stat-label">In Buffer</div>
                <div class="stat-value" id="stat-buffer">0</div>
            </div>
        </div>
    </div>

    <!-- Console Log -->
    <div class="container">
        <h2>üìã Console Log</h2>
        <button onclick="clearLog()">Clear Log</button>
        <button onclick="exportLog()" class="btn-success">Export Log</button>
        <div class="log-container" id="log-container"></div>
    </div>

    <script type="module">
        // Import c√°c modules c·∫ßn thi·∫øt
        import { EventBuffer, EventDispatcher } from '../src/core/index.js';

        // Kh·ªüi t·∫°o EventBuffer v√† EventDispatcher
        const eventBuffer = new EventBuffer({
            maxQueueSize: 100,
            maxRetries: 3,
            offlineStorage: true
        });

        const eventDispatcher = new EventDispatcher({
            endpoint: 'http://localhost:3000/api/events',
            timeout: 5000
        });

        // Statistics
        let stats = {
            sent: 0,
            success: 0,
            failed: 0
        };

        // Global functions
        window.eventBuffer = eventBuffer;
        window.eventDispatcher = eventDispatcher;
        window.stats = stats;

        // H√†m log
        function log(message, type = 'info') {
            const logContainer = document.getElementById('log-container');
            const entry = document.createElement('div');
            entry.className = `log-entry log-${type}`;
            const timestamp = new Date().toLocaleTimeString();
            entry.textContent = `[${timestamp}] ${message}`;
            logContainer.appendChild(entry);
            logContainer.scrollTop = logContainer.scrollHeight;
            console.log(message);
        }

        window.log = log;

        // C·∫≠p nh·∫≠t statistics
        function updateStats() {
            document.getElementById('stat-sent').textContent = stats.sent;
            document.getElementById('stat-success').textContent = stats.success;
            document.getElementById('stat-failed').textContent = stats.failed;
            document.getElementById('stat-buffer').textContent = eventBuffer.getQueueSize();
        }

        window.updateStats = updateStats;

        // T·∫°o event object
        function createEvent(formData) {
            return {
                id: 'evt_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9),
                timestamp: new Date().toISOString(),
                eventTypeId: parseInt(formData.get('eventTypeId')),
                trackingRuleId: parseInt(formData.get('trackingRuleId')),
                domainKey: formData.get('domainKey'),
                userField: formData.get('userField'),
                userValue: formData.get('userValue'),
                itemField: formData.get('itemField'),
                itemValue: formData.get('itemValue'),
                ratingValue: formData.get('ratingValue') ? parseFloat(formData.get('ratingValue')) : undefined,
                reviewValue: formData.get('reviewValue') || undefined
            };
        }

        // X·ª≠ l√Ω form g·ª≠i event ƒë∆°n l·∫ª
        document.getElementById('single-event-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const formData = new FormData(e.target);
            const event = createEvent(formData);
            
            log(`ƒêang g·ª≠i event: ${event.id}`, 'info');
            stats.sent++;
            
            try {
                const success = await eventDispatcher.send(event);
                
                if (success) {
                    log(`‚úÖ Event ${event.id} sent successfully`, 'success');
                    stats.success++;
                } else {
                    log(`‚ùå Failed to send event ${event.id}`, 'error');
                    stats.failed++;
                    eventBuffer.add(event);
                    log(`üì¶ Event added to buffer for retry`, 'warning');
                }
            } catch (error) {
                log(`‚ùå Error sending event: ${error.message}`, 'error');
                stats.failed++;
                eventBuffer.add(event);
            }
            
            updateStats();
        });

        // G·ª≠i batch events
        window.sendBatchEvents = async function() {
            const count = parseInt(document.getElementById('batch-count').value);
            const eventType = parseInt(document.getElementById('batch-event-type').value);
            
            log(`ƒêang g·ª≠i ${count} events...`, 'info');
            
            const events = [];
            for (let i = 0; i < count; i++) {
                events.push({
                    id: 'evt_' + Date.now() + '_' + i,
                    timestamp: new Date().toISOString(),
                    eventTypeId: eventType,
                    trackingRuleId: 1,
                    domainKey: 'test-domain',
                    userField: 'userId',
                    userValue: 'user' + (Math.floor(Math.random() * 100)),
                    itemField: 'itemId',
                    itemValue: 'item' + (Math.floor(Math.random() * 1000)),
                    ratingValue: Math.floor(Math.random() * 5) + 1
                });
            }
            
            stats.sent += count;
            
            try {
                const success = await eventDispatcher.sendBatch(events);
                
                if (success) {
                    log(`‚úÖ Batch of ${count} events sent successfully`, 'success');
                    stats.success += count;
                } else {
                    log(`‚ùå Failed to send batch`, 'error');
                    stats.failed += count;
                    events.forEach(event => eventBuffer.add(event));
                    log(`üì¶ ${count} events added to buffer for retry`, 'warning');
                }
            } catch (error) {
                log(`‚ùå Error sending batch: ${error.message}`, 'error');
                stats.failed += count;
                events.forEach(event => eventBuffer.add(event));
            }
            
            updateStats();
        };

        // G·ª≠i random events
        window.sendRandomEvents = async function() {
            const eventTypes = [1, 2, 3, 4, 5];
            const count = Math.floor(Math.random() * 10) + 1;
            
            log(`ƒêang g·ª≠i ${count} random events...`, 'info');
            
            for (let i = 0; i < count; i++) {
                const event = {
                    id: 'evt_' + Date.now() + '_' + i,
                    timestamp: new Date().toISOString(),
                    eventTypeId: eventTypes[Math.floor(Math.random() * eventTypes.length)],
                    trackingRuleId: Math.floor(Math.random() * 5) + 1,
                    domainKey: 'test-domain',
                    userField: 'userId',
                    userValue: 'user' + Math.floor(Math.random() * 100),
                    itemField: 'itemId',
                    itemValue: 'item' + Math.floor(Math.random() * 1000),
                    ratingValue: Math.random() > 0.5 ? Math.floor(Math.random() * 5) + 1 : undefined,
                    reviewValue: Math.random() > 0.7 ? 'Sample review text' : undefined
                };
                
                stats.sent++;
                
                const success = await eventDispatcher.send(event);
                if (success) {
                    stats.success++;
                } else {
                    stats.failed++;
                    eventBuffer.add(event);
                }
            }
            
            log(`‚úÖ Completed sending ${count} random events`, 'success');
            updateStats();
        };

        // Test offline mode
        window.testOfflineMode = function() {
            log('üîå Testing offline mode...', 'warning');
            
            // Th√™m 5 events v√†o buffer
            for (let i = 0; i < 5; i++) {
                const event = {
                    id: 'offline_' + Date.now() + '_' + i,
                    timestamp: new Date().toISOString(),
                    eventTypeId: 3,
                    trackingRuleId: 1,
                    domainKey: 'test-domain',
                    userField: 'userId',
                    userValue: 'user_offline',
                    itemField: 'itemId',
                    itemValue: 'item_offline_' + i,
                    ratingValue: 5
                };
                eventBuffer.add(event);
            }
            
            log('üì¶ Added 5 events to buffer (simulating offline)', 'info');
            log('üí° Refresh the page to test persistence', 'info');
            updateStats();
        };

        // Test retry logic
        window.testRetryLogic = async function() {
            log('üîÑ Testing retry logic...', 'warning');
            
            const batch = eventBuffer.getBatch(10);
            if (batch.length === 0) {
                log('‚ö†Ô∏è No events in buffer to retry', 'warning');
                return;
            }
            
            log(`Found ${batch.length} events in buffer`, 'info');
            
            const success = await eventDispatcher.sendBatch(batch);
            
            if (success) {
                eventBuffer.removeBatch(batch);
                log(`‚úÖ Successfully sent ${batch.length} events from buffer`, 'success');
                stats.success += batch.length;
            } else {
                batch.forEach(event => eventBuffer.markFailed(event));
                log(`‚ùå Failed to send batch, marked for retry`, 'error');
            }
            
            updateStats();
        };

        // Clear buffer
        window.clearBuffer = function() {
            eventBuffer.clear();
            log('üóëÔ∏è Buffer cleared', 'info');
            updateStats();
        };

        // Clear log
        window.clearLog = function() {
            document.getElementById('log-container').innerHTML = '';
            log('Log cleared', 'info');
        };

        // Export log
        window.exportLog = function() {
            const logContainer = document.getElementById('log-container');
            const logs = logContainer.innerText;
            const blob = new Blob([logs], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'event-log-' + Date.now() + '.txt';
            a.click();
            log('üì• Log exported', 'success');
        };

        // Fill sample data
        window.fillSampleData = function() {
            document.querySelector('[name="eventTypeId"]').value = '3';
            document.querySelector('[name="trackingRuleId"]').value = '1';
            document.querySelector('[name="domainKey"]').value = 'test-domain';
            document.querySelector('[name="userField"]').value = 'userId';
            document.querySelector('[name="userValue"]').value = 'user_' + Math.floor(Math.random() * 1000);
            document.querySelector('[name="itemField"]').value = 'itemId';
            document.querySelector('[name="itemValue"]').value = 'item_' + Math.floor(Math.random() * 1000);
            document.querySelector('[name="ratingValue"]').value = (Math.floor(Math.random() * 5) + 1);
            document.querySelector('[name="reviewValue"]').value = 'This is a sample review for testing purposes.';
            log('‚úèÔ∏è Sample data filled', 'info');
        };

        // Initial log
        log('‚ú® Event Posting Test initialized', 'success');
        log('üì° Server endpoint: ' + eventDispatcher.endpoint, 'info');
        updateStats();
    </script>
</body>
</html>
